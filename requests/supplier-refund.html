<!DOCTYPE html>
<html lang="en">

<head>
    <meta charset="utf-8">
    <meta name="viewport" content="width=device-width, initial-scale=1">
    <title>Constru App | Solicitud</title>
    <link rel="stylesheet"
    href="https://fonts.googleapis.com/css?family=Source+Sans+Pro:300,400,400i,700&display=fallback">
  <link rel="stylesheet" href="plugins/fontawesome-free/css/all.min.css">
  <link rel="stylesheet" href="https://code.ionicframework.com/ionicons/2.0.1/css/ionicons.min.css">
  <link rel="stylesheet" href="plugins/icheck-bootstrap/icheck-bootstrap.min.css">
  <link rel="stylesheet" href="plugins/jqvmap/jqvmap.min.css">
  <link rel="stylesheet" href="dist/css/adminlte.min.css">
  <link rel="stylesheet" href="plugins/overlayScrollbars/css/OverlayScrollbars.min.css">
  <link rel="stylesheet" href="plugins/daterangepicker/daterangepicker.css">
  <link rel="stylesheet" href="plugins/datatables-bs4/css/dataTables.bootstrap4.min.css">
  <link rel="stylesheet" href="plugins/datatables-responsive/css/responsive.bootstrap4.min.css">
  <link rel="stylesheet" href="plugins/datatables-buttons/css/buttons.bootstrap4.min.css">
  <link rel="stylesheet" href="../administrator/plugins/select2/css/select2.min.css">

    <style>
        #example1 th {
            font-weight: 500;
            text-align: center;
        }

        small {
            color: red;
        }

        
    .select2-selection__rendered {
      line-height: 31px !important;
      border-color: #ccc;
    }

    .select2-container .select2-selection--single {
      height: 35px !important;
      border: 1px solid #ccc;
    }

    .select2-selection__arrow {
      height: 34px !important;
    }
    </style>

</head>

<body id="new_requestDIV" class="hold-transition sidebar-mini layout-fixed">
    <div class="wrapper">


        <div class="preloader flex-column justify-content-center align-items-center">
            <img class="animation__shake" src="../img/AdminLTELogo.png" alt="AdminLTELogo" height="60" width="60">
          </div>
          <nav class="main-header navbar navbar-expand navbar-white navbar-light">
      
            <ul class="navbar-nav">
              <li class="nav-item">
                <a class="nav-link" data-widget="pushmenu" href="#" role="button"><i class="fas fa-bars"></i></a>
              </li>
              <li class="nav-item d-none d-sm-inline-block">
                <a href="#" class="nav-link">SOLICITUDES</a>
              </li>
      
            </ul>
            <ul class="navbar-nav ml-auto">
      
      
              <li class="nav-item dropdown">
                <a class="nav-link" id="user" data-toggle="dropdown" href="#"></a>
                <div class="dropdown-menu dropdown-menu-lg dropdown-menu-right">
                  <a href="../controllers/logout.php" class="dropdown-item">Logout</a>
      
      
                </div>
              </li>
      
            </ul>
          </nav>
      
          <aside class="main-sidebar sidebar-dark-primary elevation-4">
      
            <a href="#" class="brand-link">
              <p class="brand-text font-weight-light" style="text-align: center; font-size: 30px; letter-spacing: 1px">CONSTRU
                <strong>APP</strong>
              </p>
            </a>
      
      
            <div class="sidebar">
      
              <div class="user-panel mt-3 pb-3 mb-3 d-flex">
                <div class="image">
      
                  <i class="fas fa-search fa-user" style="font-size: 24px; color: #fff; margin-top: 12px"></i>
                </div>
                <div class="info">
                  <a href="#" class="d-block" id="sidebar_username"></a>
                  <a class="d-block" id="sidebar_user_role" style="font-size: 14px; color: #fff; font-weight: 500; letter-spacing: 1px;"></a>
                </div>
              </div>
      
      
      
              <nav class="mt-2">
                <ul class="nav nav-pills nav-sidebar flex-column" data-widget="treeview" role="menu" data-accordion="false">
      
                  <li class="nav-header">BODEGUERO</li>
                  <li class="nav-item">
                    <a href="#" class="nav-link">
                      <i class="nav-icon fas fa-shopping-cart"></i>
                      <p>
                          Entregas
                          <i class="right fas fa-angle-left"></i>
                      </p>
                    </a>
                    <ul class="nav nav-treeview">
                        <li class="nav-item">
                            <a href="material-delivery.html" class="nav-link">
                              <i class="fas fa-circle nav-icon"></i>
                              <p>Nueva Entrega</p>
                            </a>
                        </li>
                        <li class="nav-item">
                            <a href="material-deliveries.html" class="nav-link">
                              <i class="fas fa-circle nav-icon"></i>
                              <p>Ver Entregas</p>
                            </a>
                        </li>
                      
                    </ul>
                  </li>
                  <li class="nav-item">
                      <a href="#" class="nav-link">
                        <i class="nav-icon fas fa-window-restore"></i>
                        <p>
                            Recepciones
                          <i class="right fas fa-angle-left"></i>
                        </p>
                      </a>
                      <ul class="nav nav-treeview">
                          <li class="nav-item">
                              <a href="material-return.html" class="nav-link">
                                <i class="fas fa-circle nav-icon"></i>
                                <p>Nuevo Recibo</p>
                              </a>
                          </li>
                          <!-- <li class="nav-item">
                              <a href="#" class="nav-link">
                                <i class="fas fa-circle nav-icon"></i>
                                <p>Ver Recibos</p>
                              </a>
                          </li> -->
                        
                      </ul>
                    </li>
                    <li class="nav-item">
                        <a href="#" class="nav-link">
                          <i class="nav-icon fas fa-truck"></i>
                          <p>
                              Proveedor
                            <i class="right fas fa-angle-left"></i>
                          </p>
                        </a>
                        <ul class="nav nav-treeview">
                            <li class="nav-item">
                                <a href="materials-receive-supplier.html" class="nav-link">
                                  <i class="fas fa-circle nav-icon"></i>
                                  <p>Recepción De material</p>
                                </a>
                            </li>
                            
                            <li class="nav-item">
                                <a href="supplier-refund.html" class="nav-link">
                                  <i class="fas fa-circle nav-icon"></i>
                                  <p>Devolución Material</p>
                                </a>
                            </li>
                          
                        </ul>
                      </li>
                      
                 
                  <li class="nav-item">
                      <a href="warehouse-supply.html" class="nav-link">
                        <i class="fas fa-house-user nav-icon"></i>
                        <p>Abastecimiento Bodega
                          </p>
                      </a>
                  </li>
                  <li class="nav-item">
                      <a href="#" class="nav-link">
                        <i class="nav-icon fas fa-chalkboard-teacher"></i>
                        <p>
                            Solicitudes
                          <i class="right fas fa-angle-left"></i>
                        </p>
                      </a>
                      <ul class="nav nav-treeview">
                          <li class="nav-item">
                              <a href="new-request.html" class="nav-link">
                                <i class="fas fa-circle nav-icon"></i>
                                <p>Nueva Solicitud</p>
                              </a>
                          </li>
                          
      
                          <li class="nav-item">
                              <a href="requests.html" class="nav-link">
                                <i class="fas fa-circle nav-icon"></i>
                                <p>Ver Solicitudes</p>
                              </a>
                          </li>
                          
                        
                      </ul>
                    </li>
                    <li class="nav-item">
                        <a href="#" class="nav-link">
                          <i class="nav-icon fas fa-store-alt"></i>
                          <p>
                              Inventario
                            <i class="right fas fa-angle-left"></i>
                          </p>
                        </a>
                        <ul class="nav nav-treeview">
                            <li class="nav-item">
                                <a href="inventory-stock.html" class="nav-link">
                                  <i class="fas fa-circle nav-icon"></i>
                                  <p>
                                      Materiales De Inventario</p>
                                </a>
                            </li>
                            
        
                            <li class="nav-item">
                                <a href="materials-inventory.html" class="nav-link">
                                  <i class="fas fa-circle nav-icon"></i>
                                  <p>Ver Registros</p>
                                </a>
                            </li>
                            <li class="nav-item">
                                <a href="material_receipt.html" class="nav-link">
                                  <i class="fas fa-circle nav-icon"></i>
                                  <p>Nuevo Registro</p>
                                </a>
                            </li>
                          
                            
                          
                        </ul>
                      </li>
                 
                  
      
      
                  <li class="nav-item">
                    <a href="../controllers/logout.php" class="nav-link">
                      <i class="nav-icon far fa-circle text-warning"></i>
                      <p>Logout</p>
                    </a>
                  </li>
      
                </ul>
              </nav>
      
            </div>
      
          </aside>


        <div class="content-wrapper">
            <section class="content">
                <div class="container-fluid">
                    <div class="row">

                        <div class="col-md-12" style="margin-top: 20px;">

                            <div class="card card-light">
                                <div class="card-header">
                                    <h3 class="card-title"></h3>Devolución Al Proveedor</h3>
                                </div>
                                <form id="requestForm" href="#" method="POST">
                                    <div class="card-body">
                                        <div class="row">
                                            <div class="col-md-6">
                                                <div class="form-group">
                                                    <label style="font-weight: 500; font-size: 16px;">Receipt #</label>
                                                    <select class="form-control form-control-sm" id="receipt_number"
                                                        name="receipt_number" style="width: 100%;">
                                                        <option>Por Favor Seleccione Recibo </option>

                                                    </select>
                                                </div>

                                            </div>
                                            <div class="col-md-2">
                                                <button type="button" class="btn-sm btn-primary"  style="margin-top: 31px; width: 100%;" id="receiptBtn">Buscar</button>



                                            </div>



                                        </div>
                                        <div class="row">
                                            <div class="col-md-3">
                                                <div class="form-group">
                                                    <label style="font-weight: 500; font-size: 16px;">Recibo Por</label>
                                                    <input class="form-control form-control-sm" id="receipt_by"
                                                        name="receipt_by" readonly />
                                                </div>
                                                <small></small>


                                            </div>
                                            <div class="col-md-3">
                                                <div class="form-group">
                                                    <label style="font-weight: 500; font-size: 16px;">Nombre Del
                                                        Proveedor</label>
                                                    <input class="form-control form-control-sm" id="supplier_name"
                                                        name="supplier_name" readonly />
                                                </div>
                                                <small></small>


                                            </div>
                                            <div class="col-md-3">
                                                <div class="form-group">
                                                    <label style="font-weight: 500; font-size: 16px;">Buscar
                                                        Documento</label>
                                                    <input class="form-control form-control-sm" id="material_doc"
                                                        name="material_doc" readonly />
                                                </div>
                                                <small></small>


                                            </div>
                                            <div class="col-md-3">
                                                <div class="form-group">
                                                    <label style="font-weight: 500; font-size: 16px;">Tipo
                                                        Documento</label>
                                                    <input class="form-control form-control-sm" id="unit_doc"
                                                        name="unit_doc" readonly />
                                                </div>
                                                <small></small>


                                            </div>


                                        </div>
                                        <div class="row">
                                            <div class="col-md-6">
                                                <div class="form-group">
                                                    <label style="font-weight: 500; font-size: 16px;">Documentos</label>
                                                    <div class="input-group input-file" name="Fichier1">
                                                        <input type="text" class="form-control  form-control-sm"
                                                            id="documents" name="documents"
                                                            placeholder='Subir Documento...' />

                                                    </div>
                                                </div>
                                                <small></small>


                                            </div>
                                            <div class="col-md-2">
                                                <button class="btn-sm btn-primary btn-choose" type="button"
                                                    style="width: 100%;margin-top: 34px">Navegar</button>

                                            </div>
                                            <div class="col-md-2">
                                                <button class="btn-sm btn-warning btn-reset" type="button"
                                                    style="width: 100%;margin-top: 34px">Resetear</button>

                                            </div>



                                        </div>




                                        <div class="row">
                                            <div class="col-md-4">
                                                <div class="form-group">
                                                    <label style="font-weight: 500; font-size: 16px;">Materiales</label>
                                                    <select class="form-control form-control-sm" id="materials"
                                                        name="materials" style="width: 100%">
                                                        <option value="">Por Favor Seleccione Material</option>
                                                    </select>

                                                </div>

                                            </div>
                                            <div class="col-md-2">
                                                <div class="form-group">
                                                    <button class="btn-sm btn-primary"
                                                        style="margin-top: 30px; width: 100%;"
                                                        id="materialBtn">Buscar</button>

                                                </div>

                                            </div>
                                            

                                        </div>
                                        <div class="row">
                                            <div class="col-md-1">
                                                <div class="form-group">
                                                    <label for="exampleInputEmail1"
                                                        style="font-weight: 500; font-size: 16px;">Material Id</label>
                                                    <input type="text" class="form-control form-control-sm" id="mat_id"
                                                        name="mat_id" readonly>
                                                    <small></small>
                                                </div>

                                            </div>
                                            <div class="col-md-5">
                                                <div class="form-group">
                                                    <label for="exampleInputEmail1"
                                                        style="font-weight: 500; font-size: 16px;">Nombre
                                                        Insumo</label>
                                                    <input type="text" class="form-control form-control-sm" readonly
                                                        id="material_name" name="material_name">
                                                    <small></small>
                                                </div>

                                            </div>
                                            <div class="col-md-2">
                                                <div class="form-group">
                                                    <label for="exampleInputEmail1"
                                                        style="font-weight: 500; font-size: 16px;">Unid Medida</label>
                                                    <input type="text" readonly class="form-control form-control-sm" id="unit" name="unit"/>
                                                    <small></small>
                                                </div>

                                            </div>
                                            <div class="col-md-1">
                                                <div class="form-group">
                                                    <label for="exampleInputEmail1"
                                                        style="font-weight: 500; font-size: 16px;">Cantidad</label>
                                                    <input class="form-control form-control-sm" id="quantity"
                                                        name="quantity" value="0" style="text-align: right" />
                                                    <small></small>
                                                </div>

                                            </div>

                                            <div class="col-md-3">
                                                <button class="btn-sm btn-primary"
                                                    style="margin-top: 30px; width: 100%;" id="addBtn">Agregar</button>


                                            </div>

                                        </div>

                                        <div class="row" style="display: none;" id="tableDiv">
                                            <div class="col-12">
                                                <table id="example1" class="table table-bordered table-striped">
                                                    <thead style="background-color: #343a40; color: #fff;">
                                                        <tr>
                                                            <th>Material Id</th>
                                                            <th>Material</th>
                                                            <th>Cantidad</th>
                                                            <th>Tipo</th>
                                                            <th>Acción</th>
                                                        </tr>
                                                    </thead>
                                                    <tbody id="table">

                                                    </tbody>


                                                </table>
                                            </div>
                                        </div>
                                    </div>
                                    <!-- /.card-body -->

                                    <div class="card-footer">
                                        <button id="submitBtn" type="submit" style="float: right;"
                                            class="btn btn-success">Enviar</button>
                                    </div>
                                </form>
                                <div class="modal fade modal-center" id="myModal" tabindex="-1" role="dialog"
                                aria-labelledby="exampleModalLabel" aria-hidden="true">
                                <div class="modal-dialog" role="document">
                                  <div class="modal-content">
                                    <div class="modal-header">
                                      <h5 class="modal-title" id="exampleModalLabel">Verificador De Perfil</h5>
                                      <button type="button" class="close" data-dismiss="modal" aria-label="Close">
                                        <span aria-hidden="true">&times;</span>
                                      </button>
                                    </div>
                                    <div class="modal-body">
                                      <div class="form-group">
                                        <label for="exampleInputEmail1" style="font-weight: 500; font-size: 16px;">Ingrese Su
                                          Clave</label>
                                        <input type="password" class="form-control" id="password_Input" name="password_Input"
                                          required />
              
              
                                      </div>
                                    </div>
                                    <div class="modal-footer">
                                      <button type="button" class="btn btn-secondary" data-dismiss="modal">Cancelar</button>
                                      <button type="button" id="check_BTn" class="btn btn-success">Validar</button>
                                    </div>
                                  </div>
                                </div>
                              </div>
                            </div>




                        </div>


                    </div>

                </div>
            </section>

        </div>

        <footer class="main-footer">
            <p style="text-align: center">Copyright &copy; 2021 <a href="#">ConstruApp</a>. All rights reserved.</p>


        </footer>
        <aside class="control-sidebar control-sidebar-dark">
        </aside>
    </div>

    <script src="plugins/jquery/jquery.min.js"></script>
  <script src="plugins/jquery-ui/jquery-ui.min.js"></script>
  <script>
    $.widget.bridge('uibutton', $.ui.button)
  </script>
  <script src="plugins/bootstrap/js/bootstrap.bundle.min.js"></script>
  <script src="plugins/datatables/jquery.dataTables.min.js"></script>
  <script src="plugins/datatables-bs4/js/dataTables.bootstrap4.min.js"></script>
  <script src="plugins/datatables-responsive/js/dataTables.responsive.min.js"></script>
  <script src="plugins/chart.js/Chart.min.js"></script>
  <script src="plugins/jqvmap/jquery.vmap.min.js"></script>
  <script src="plugins/jqvmap/maps/jquery.vmap.usa.js"></script>
  <script src="plugins/jquery-knob/jquery.knob.min.js"></script>
  <script src="plugins/moment/moment.min.js"></script>
  <script src="plugins/daterangepicker/daterangepicker.js"></script>
  <script src="plugins/overlayScrollbars/js/jquery.overlayScrollbars.min.js"></script>
  <script src="dist/js/adminlte.js"></script>
  <script src="dist/js/demo.js"></script>
  <script src="dist/js/jquery.validate.min.js"></script>
  <script src="dist/js/additional-methods.min.js"></script>
  <script src="dist/js/functions.js"></script>
  <script src="../administrator/plugins/select2/js/select2.min.js"></script>
    <script>
        $(document).ready(function () {
            var table = $("#example1").DataTable({
                "responsive": true,
                "lengthChange": false,
                "autoWidth": false,

            });
            $("#receiptBtn").on("click", function(e){
                e.preventDefault();
                var receipt_ID = $("#receipt_number").val();
                if(receipt_ID != "")
                {
                    $.ajax({
                        type: "POST",
                        url: "../controllers/controller.php",
                        dataType: "JSON",
                        data: { action: "get_Receipt_Data", receipt_ID: receipt_ID },
                        success: function (response) {
                            if (response["receipt"] != "" && response["login"] == true) {
                                $("#receipt_by").val(response["receipt"]["RECEIVER_NAME"]);
                                $("#supplier_name").val(response["receipt"]["SUPPLIER_NAME"]);
                                $("#material_doc").val(response["receipt"]["MATERIAL_DOC"]);
                                $("#unit_doc").val(response["receipt"]["TIPO_DOC"]);
                                jQuery.each(response["receipt"]["materials"], function (index, value) {
                                    $("#materials").append("<option value=" + value['ID'] + " style='text-transform: initial'>" + value['NAM'] + "</option>");
                                });

                            }

                        },
                    });

                }
                

            });
            $("#materialBtn").on("click", function (e) {
                e.preventDefault();
                var data = $('#materials').select2('data');
                var material_ID = data[0].id;
                var receipt_ID  = $("#receipt_number").val();
                $.ajax({
                    type: "POST",
                    url: "../controllers/controller.php",
                    dataType: "JSON",
                    data: { action: "get_material_details", material_ID: material_ID, receipt_ID: receipt_ID },
                    success: function (response) {
                        if (response["data"] && response["data"] != "") 
                        {
                            $("#mat_id").val(response["data"]["ID"]);
                            $("#material_name").val(response["data"]["NAME"]);
                            $("#unit").val(response["data"]["UNIT"]);
                            $("#quantity").val(response["data"]["QTY"]);


                        }

                    },
                });

            });
            $("#addBtn").on("click", function (e) {
                e.preventDefault();
                var data = $('#materials').select2('data');
                var material_ID = data[0].id;
                var material_name = data[0].text;
                var amount = $("#quantity").val();
                var unit = $("#unit").val();
                if (materials != "" && amount != 0 && unit != "") {
                    $("#materials option[value=" + material_ID + "]").remove();
                    table.row.add([material_ID, material_name, amount, unit, "<button type='button' style='width: 100%' class='btn btn-danger'><i class='far fa-trash-alt'></i>&nbsp&nbsp&nbsp&nbspBorrar</button>"]).draw(false);
                    $("#quantity").val(0);
                    $("#mat_id").val("");
                    $("#tableDiv").show();
                    $('#materials').select2("", "Por Favor Seleccione Material");
                    $("#material_name").val("") ;


                }
                else {
                    alert("Seleccione el tipo de Material");
                }





            });
            $('#example1').on("click", "button", function (e) {
                e.preventDefault();
                var row = table.row($(this).parents('tr')).data();
                var id = row[0];
                var material = row[1];
                $("#materials").append("<option value=" + id + ">" + material + "</option>")
                table.row($(this).parents('tr')).remove().draw(false);

            });
            $('#requestForm').validate({
                rules:
                {
                    documents:
                    {
                        required: true,


                    }
                },
                messages: {
                    doc_number: {
                        required: "Este Campo Es Obligatorio",

                    },
                    

                },
                errorPlacement: function (error, element) {

                    $(element).next("small").text($(error).text());
                },
                success: function (element) {
                    $(element).next("small").text("");
                },

            });

            $("#requestForm").on("submit", function (e) {
                e.preventDefault();
                // $("#submitBtn").css("display", "none");
                if ($("#requestForm").valid() == true) {
                    var materials = Array();
                    var data = table.rows().data().toArray();;
                    if (materials.length < 0) {
                        alert("Por Favor Agregue Materiales");
                    }
                    if (materials.length >= 0) {
                        $('#myModal').modal('show');

                        // var formData = new FormData(this);
                        // formData.append("action", "material_return_supplier");
                        // formData.append("materials", JSON.stringify(data));

                        // $.ajax({
                        //     type: "POST",
                        //     url: "../controllers/controller.php",
                        //     cache: false,
                        //     dataType: "JSON",
                        //     contentType: false,
                        //     processData: false,
                        //     data: formData,
                        //     success: function (response) {
                        //         if (response["receipt_status"] == true) {
                        //             alert("Solicitud Enviada Con éxito, Gracias !");
                        //             window.location.href = "requests.html";

                        //         }
                        //         if (response["receipt_status"] == false) {
                        //             alert("Ha Ocurrido Un Error. Por Favor Intente De Nuevo");

                        //         }

                        //     }

                        // });
                    }




                }


            });
            $("#check_BTn").on("click", function (e) {
                e.preventDefault();
                var userpassword = $("#password_Input").val();
                var response = CheckPassword(userpassword);
                if (response["status"] == true && response["login"] == true) {
                    var materials = Array();
                    var data = table.rows().data().toArray();;
                    if (data.length < 0) {
                        alert("Por Favor Agregue Materiales");
                    }
                    if (data.length >= 0) 
                    {
                        var form = $("#requestForm");
                        var formData = new FormData(form[0]);
                        formData.append("action", "material_return_supplier");
                        formData.append("materials", JSON.stringify(data));
                        $.ajax({
                        type: "POST",
                        url: "../controllers/controller.php",
                        cache: false,
                        dataType: "JSON",
                        contentType: false,
                        processData: false,
                        data: formData,
                        success: function (response) 
                        {
                            if(response["login"] == false)
                            {
                                window.location.href    = "../index.html";
                            }
                            if(response["login"] == true)
                            {
                                
                                if (response["status"] == true) 
                                {
                                    alert("Devolución Enviada Con éxito !");
                                    window.location.reload();

                                }
                                if (response["status"] == false) 
                                {
                                    alert("Ha Ocurrido Un Error Por Favor Intente De Nuevo Más Tarde");

                                }

                            }

                        }

                    });



                       
                    }

                    




                }
                else {
                    alert("Contraseña Invalida");
                }



            });
            $(function () {
                bs_input_file();
            });
            $("#receipt_number").select2();
            $("#materials").select2();
            var res = getUser();
            if (res["login"] == false) {
                window.location.href = "../index.html";
            }
            var response = getUser();
            if (response["login"] == true && response["user"]) {
                $("#name_applicant").val(response["user"]["NAME"]);
                $("#user_role").text(res["user"]["DESIGNATION"]);
                $("#user").text(response["user"]["NAME"]);
                $("#receiver_name").val(response["user"]["NAME"]);



            }
            var response = get_Receipts_List();
            if (response["receipts"]) {
                jQuery.each(response["receipts"], function (index, value) {
                    $("#receipt_number").append("<option value=" + value['ID'] + " style='text-transform: initial'>" + value['ID'] + "</option>");
                });


            }

            
            

            
            








        });










    </script>
</body>

</html>
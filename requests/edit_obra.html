<!DOCTYPE html>
<html lang="en">

<head>
  <meta charset="utf-8">
  <meta name="viewport" content="width=device-width, initial-scale=1">
  <title>Constru App | Administrator De Obra</title>
  <link rel="stylesheet"
    href="https://fonts.googleapis.com/css?family=Source+Sans+Pro:300,400,400i,700&display=fallback">
  <link rel="stylesheet" href="plugins/fontawesome-free/css/all.min.css">
  <link rel="stylesheet" href="plugins/datatables-bs4/css/dataTables.bootstrap4.min.css">
  <link rel="stylesheet" href="plugins/datatables-responsive/css/responsive.bootstrap4.min.css">
  <link rel="stylesheet" href="plugins/datatables-buttons/css/buttons.bootstrap4.min.css">
  <link rel="stylesheet" href="dist/css/adminlte.min.css">
  <link rel="stylesheet" href="../administrator/plugins/select2/css/select2.min.css">


  <style>
    .profile-pic-wrapper {
      width: 100%;
      position: relative;
      display: flex;
      flex-direction: column;

    }

    .pic-holder {
      text-align: center;
      position: relative;
      border-radius: 50%;
      width: 150px;
      height: 150px;
      overflow: hidden;
      display: flex;
      justify-content: center;
      align-items: center;
      margin-bottom: 20px;
    }

    .pic-holder .pic {
      height: 150px;
      width: 150px;
      -o-object-fit: cover;
      object-fit: cover;
      -o-object-position: center;
      object-position: center;
    }

    .pic-holder .upload-file-block,
    .pic-holder .upload-loader {
      position: absolute;
      top: 0;
      left: 0;
      height: 100%;
      width: 100%;
      background-color: rgba(90, 92, 105, 0.7);
      color: #f8f9fc;
      font-size: 12px;
      font-weight: 600;
      opacity: 0;
      display: flex;
      align-items: center;
      justify-content: center;
      transition: all 0.2s;
    }

    .pic-holder .upload-file-block {
      cursor: pointer;
    }

    .pic-holder:hover .upload-file-block {
      opacity: 1;
    }

    .pic-holder.uploadInProgress .upload-file-block {
      display: none;
    }

    .pic-holder.uploadInProgress .upload-loader {
      opacity: 1;
    }

    /* Snackbar css */
    .snackbar {
      visibility: hidden;
      min-width: 250px;
      background-color: #333;
      color: #fff;
      text-align: center;
      border-radius: 2px;
      padding: 16px;
      position: fixed;
      z-index: 1;
      left: 50%;
      bottom: 30px;
      font-size: 14px;
      transform: translateX(-50%);
    }

    .snackbar.show {
      visibility: visible;
      -webkit-animation: fadein 0.5s, fadeout 0.5s 2.5s;
      animation: fadein 0.5s, fadeout 0.5s 2.5s;
    }

    @-webkit-keyframes fadein {
      from {
        bottom: 0;
        opacity: 0;
      }

      to {
        bottom: 30px;
        opacity: 1;
      }
    }

    @keyframes fadein {
      from {
        bottom: 0;
        opacity: 0;
      }

      to {
        bottom: 30px;
        opacity: 1;
      }
    }

    @-webkit-keyframes fadeout {
      from {
        bottom: 30px;
        opacity: 1;
      }

      to {
        bottom: 0;
        opacity: 0;
      }
    }

    @keyframes fadeout {
      from {
        bottom: 30px;
        opacity: 1;
      }

      to {
        bottom: 0;
        opacity: 0;
      }
    }

    small {
      color: red;
    }
  </style>



</head>

<body class="hold-transition sidebar-mini layout-fixed">
  <div class="wrapper">


    <div class="preloader flex-column justify-content-center align-items-center">
      <img class="animation__shake" src="../img/AdminLTELogo.png"  height="60" width="60">
    </div>
    <nav class="main-header navbar navbar-expand navbar-white navbar-light">

      <ul class="navbar-nav">
        <li class="nav-item">
          <a class="nav-link" data-widget="pushmenu" href="#" role="button"><i class="fas fa-bars"></i></a>
        </li>
        <li class="nav-item d-none d-sm-inline-block">
          <a href="#" class="nav-link">Nueva Obra</a>
        </li>

      </ul>
      <ul class="navbar-nav ml-auto">

        <li class="nav-item dropdown">
          <a class="nav-link" id="user" data-toggle="dropdown" href="#"></a>
          <div class="dropdown-menu dropdown-menu-lg dropdown-menu-right">
            <a href="../controllers/logout.php" class="dropdown-item">Logout</a>


          </div>
        </li>

      </ul>
    </nav>

    <aside class="main-sidebar sidebar-dark-primary elevation-4">

      <a href="#" class="brand-link">
        <p class="brand-text font-weight-light" style="text-align: center; font-size: 30px; letter-spacing: 1px">CONSTRU
          <strong>APP</strong>
        </p>
      </a>


      <div class="sidebar">

        <div class="user-panel mt-3 pb-3 mb-3 d-flex">
          <div class="image">

            <i class="fas fa-search fa-user" style="font-size: 24px; color: #fff; margin-top: 12px"></i>
          </div>
          <div class="info">
            <a href="#" class="d-block" id="sidebar_username"></a>
            <a class="d-block" id="sidebar_user_role" style="font-size: 14px; color: #fff; font-weight: 500; letter-spacing: 1px;"></a>
          </div>
        </div>



        <nav class="mt-2">
          <ul class="nav nav-pills nav-sidebar flex-column" data-widget="treeview" role="menu" data-accordion="false">

            <li class="nav-header" style="letter-spacing: 1px;">ADMINISTRATOR DE OBRA</li>

            <li class="nav-item">
              <a href="#" class="nav-link">
                <i class="nav-icon fas fa-city"></i>
                <p>
                  Obra
                  <i class="right fas fa-angle-left"></i>
                </p>
              </a>
              <ul class="nav nav-treeview">
                <li class="nav-item">
                  <a href="constructions.html" class="nav-link">
                    <i class="fas fa-list nav-icon"></i>
                    <p>Lista de Obra</p>
                  </a>
                </li>
                <li class="nav-item">
                  <a href="index.html" class="nav-link">
                    <i class="far fa-circle text-info nav-icon"></i>
                    <p>Nueva Obra</p>
                  </a>
                </li>
                

              </ul>
            </li>
            <li class="nav-item">
              <a href="#" class="nav-link">
                <i class="nav-icon fas fa-copy"></i>
                <p>
                  Documentos
                  <i class="right fas fa-angle-left"></i>
                </p>
              </a>
              <ul class="nav nav-treeview">
                <li class="nav-item">
                  <a href="documents.html" class="nav-link">
                    <i class="fas fa-folder-open nav-icon"></i>
                    <p>Ver documentos</p>
                  </a>
                </li>
                <li class="nav-item">
                  <a href="special-document.html" class="nav-link">
                    <i class="far fa-circle nav-icon text-info"></i>
                    <p>Nueva Documento</p>
                  </a>
                </li>
               

              </ul>
            </li>
            <li class="nav-item">
              <a href="#" class="nav-link">
                <i class="nav-icon fas fa-feather-alt"></i>
                <p>
                  Multas Y Amonestaciones
                  <i class="right fas fa-angle-left"></i>
                </p>
              </a>
              <ul class="nav nav-treeview">
                <li class="nav-item">
                  <a href="construction-fines.html" class="nav-link">
                    <i class="fas fa-list nav-icon"></i>
                    <p>Multas Obra</p>
                  </a>
                </li>


                <li class="nav-item">
                  <a href="fine_construction.html" class="nav-link">
                    <i class="far fa-circle nav-icon text-info"></i>
                    <p>Nueva Multa Obra</p>
                  </a>
                </li>
              
                <li class="nav-item">
                  <a href="workers-fines.html" class="nav-link">
                    <i class="fas fa-list nav-icon"></i>
                    <p>Amonestaciones Trabajadores</p>
                  </a>
                </li>
                <li class="nav-item">
                  <a href="fine-worker.html" class="nav-link">
                    <i class="far fa-circle nav-icon text-info"></i>
                    <p>Nueva Amonestacion De Trabajador</p>
                  </a>
                </li>

              </ul>
            </li>


            <li class="nav-item">
              <a href="workers.html" class="nav-link">
                <i class="fas fa-user-friends nav-icon"></i>
                <p>Trabajadores
                </p>
              </a>
            </li>
            <li class="nav-item">
              <a href="new-worker.html" class="nav-link">
                <i class="fas fa-user-plus nav-icon"></i>
                <p>Agregar Trabajador/a
                </p>
              </a>
            </li>
            <li class="nav-item">
              <a href="requests.html" class="nav-link">
                <i class="fas fa-list nav-icon"></i>
                <p>Ver Solicitudes</p>
              </a>
             
            </li>
            <li class="nav-item">
              <a href="comments.html" class="nav-link">
                <i class="fas fa-comments nav-icon"></i>
                <p>Comentarios</p>
              </a>
             
            </li>
            




            <li class="nav-item">
              <a href="../controllers/logout.php" class="nav-link">
                <i class="nav-icon far fa-circle text-warning"></i>
                <p>Logout</p>
              </a>
            </li>

          </ul>
        </nav>

      </div>

    </aside>

    <div class="content-wrapper" style="overflow: hidden">
      <section class="content-header">
        <div class="container-fluid">
          <div class="row mb-2">
            <div class="col-sm-6">
              <h1 id="page_heading">Modificar Obra</h1>
            </div>
            <div class="col-sm-6">
              <ol class="breadcrumb float-sm-right">
                <li class="breadcrumb-item"><a href="#">Home</a></li>
                <li id="page_navbar" class="breadcrumb-item active">Modificar Obra</li>
              </ol>
            </div>
          </div>
        </div>
      </section>
      <section class="content">
        <div class="container-fluid">
          <div class="row">
            <div class="col-12">


              <div class="card">
                <div class="card-header" style="padding-bottom: 50px">
                  <form id="constructionForm" enctype="multipart/form-data" action="#" method="POST">
                    <div class="row">
                      <div class="col-md-8">
                        <div class="row">
                          <div class="col-md-6">
                            <div class="form-group">
                              <label style="font-weight: 500; font-size: 14px;">Nombre Administrador De Obra</label>
                              <input type="text" class="form-control form-control-sm" id="name" name="name" readonly />
                              <small></small>

                            </div>

                          </div>
                          <div class="col-md-6">
                            <div class="form-group">
                              <label style="font-weight: 500; font-size: 14px;">RUT Administrador De Obra</label>
                              <input type="text" class="form-control form-control-sm" id="rut" name="rut" readonly />
                              <small></small>

                            </div>

                          </div>

                        </div>
                        <div class="row">
                          <div class="col-md-6">
                            <div class="form-group">
                              <label style="font-weight: 500; font-size: 14px;">Obra Nombre</label>
                              <input class="form-control form-control-sm" id="construction" name="construction"
                                style="width: 100%;" />
                              <small></small>

                            </div>

                          </div>
                          <div class="col-md-6">
                            <div class="form-group">
                              <label style="font-weight: 500; font-size: 14px;">Coordenadas</label>
                              <input type="text" class="form-control form-control-sm" id="coordinates"
                                name="coordinates" />
                              <small></small>

                            </div>

                          </div>

                        </div>
                        <div class="row">
                          <div class="col-md-12">
                            <div class="form-group">
                              <label style="font-weight: 500; font-size: 14px;">Direccion</label>
                              <input type="text" class="form-control form-control-sm" id="address" name="address" />
                              <small></small>

                            </div>

                          </div>

                        </div>
                        <div class="row">
                          <div class="col-md-4">
                            <div class="form-group">
                              <label style="font-weight: 500; font-size: 14px;">Empresa</label>
                              <input type="text" class="form-control form-control-sm" id="business" name="business" />
                              <small></small>

                            </div>

                          </div>
                          <div class="col-md-4">
                            <div class="form-group">
                              <label style="font-weight: 500; font-size: 14px;">Estado</label>
                              <input type="text" class="form-control form-control-sm" id="business_condition"
                                name="business_condition" />
                              <small></small>

                            </div>

                          </div>
                          <div class="col-md-4">
                            <div class="form-group">
                              <label style="font-weight: 500; font-size: 14px;">Monto</label>
                              <input type="text" class="form-control form-control-sm" id="amount" name="amount" />
                              <small></small>

                            </div>

                          </div>

                        </div>
                        <div class="row">
                          <div class="col-md-6">
                            <div class="form-group">
                              <label style="font-weight: 500; font-size: 14px;">Fecha Inicio</label>
                              <input id="start_date" name="start_date" class="form-control mb-2 mr-sm-2 form-control-sm"
                                type="text" onfocus="(this.type='date')" />

                              <small></small>

                            </div>

                          </div>
                          <div class="col-md-6">
                            <div class="form-group">
                              <label style="font-weight: 500; font-size: 14px;">Fecha Termino</label>
                              <input id="end_date" name="end_date" class="form-control mb-2 mr-sm-2 form-control-sm"
                                type="text" onfocus="(this.type='date')"/>

                              <small></small>

                            </div>

                          </div>

                        </div>

                      </div>
                      <div class="col-md-4">
                        <div class="form-group">
                          <label style="font-weight: 500; font-size: 14px; width: 100%; text-align: center">Adjuntar
                            Imagen De Perfil De Empresa (640 x 640)</label>
                          <div class="profile-pic-wrapper" style="margin-top: 10px;">
                            <div class="pic-holder" style="margin: auto">
                              <img id="profilePic" class="pic" src="./dist/img/default.jpg">
                              <label for="newProfilePhoto" class="upload-file-block">
                                <div class="text-center">
                                  <div class="mb-2">
                                    <i class="fa fa-camera fa-2x"></i>
                                  </div>
                                  <div class="text-uppercase">
                                    Upload <br /> Profile Photo
                                  </div>
                                </div>
                              </label>
                              <input class="uploadProfileInput" type="file" name="img_obra" id="newProfilePhoto"
                                accept="image/*" />
                            </div>

                            </hr>
                            <p id="imgError" class="text-info text-center small"></p>
                          </div>

                        </div>

                      </div>

                    </div>


                </div>
                <div class="card-footer">
                 
                  <button id="updateBtn" type="submit" style="float: right;" class="btn btn-warning">Actualizar</button>

                </div>



                </form>




              </div>



            </div>

          </div>

        </div>

    </div>

    </section>

  </div>

  <footer class="main-footer">
    <p style="text-align: center">Copyright &copy; 2021 <a href="#">ConstruApp</a>. All rights reserved.</p>


  </footer>
  <aside class="control-sidebar control-sidebar-dark">
  </aside>
  </div>

  <script src="plugins/jquery/jquery.min.js"></script>
  <script src="plugins/bootstrap/js/bootstrap.bundle.min.js"></script>
  <script src="plugins/datatables/jquery.dataTables.min.js"></script>
  <script src="plugins/datatables-bs4/js/dataTables.bootstrap4.min.js"></script>
  <script src="plugins/datatables-responsive/js/dataTables.responsive.min.js"></script>
  <script src="plugins/datatables-responsive/js/responsive.bootstrap4.min.js"></script>
  <script src="plugins/datatables-buttons/js/dataTables.buttons.min.js"></script>
  <script src="plugins/datatables-buttons/js/buttons.bootstrap4.min.js"></script>
  <script src="plugins/jszip/jszip.min.js"></script>
  <script src="plugins/pdfmake/pdfmake.min.js"></script>
  <script src="plugins/pdfmake/vfs_fonts.js"></script>
  <script src="plugins/datatables-buttons/js/buttons.html5.min.js"></script>
  <script src="plugins/datatables-buttons/js/buttons.print.min.js"></script>
  <script src="plugins/datatables-buttons/js/buttons.colVis.min.js"></script>
  <script src="dist/js/adminlte.min.js"></script>
  <script src="dist/js/demo.js"></script>
  <script src="../administrator/plugins/select2/js/select2.min.js"></script>
  <script src="dist/js/jquery.validate.min.js"></script>
  <script src="dist/js/additional-methods.min.js"></script>
  <script src="dist/js/functions.js"></script>


  <script>
    $(document).ready(function () {
      var image_status;
      
      $(document).on("change", ".uploadProfileInput", function () {
        var triggerInput = this;
        var currentImg = $(this).closest(".pic-holder").find(".pic").attr("src");
        var holder = $(this).closest(".pic-holder");
        var wrapper = $(this).closest(".profile-pic-wrapper");
        $(wrapper).find('[role="alert"]').remove();
        files = !!this.files ? this.files : [];
        if (!files.length || !window.FileReader) {
          return;
        }
        if (/^image/.test(files[0].type)) {
          // only image file
          var reader = new FileReader(); // instance of the FileReader
          reader.readAsDataURL(files[0]); // read the local file

          reader.onloadend = function () {
            $(holder).addClass("uploadInProgress");
            $(holder).find(".pic").attr("src", this.result);
            $(holder).append(
              '<div class="upload-loader"><div class="spinner-border text-primary" role="status"><span class="sr-only">Loading...</span></div></div>'
            );

            // Dummy timeout; call API or AJAX below
            setTimeout(() => {
              $(holder).removeClass("uploadInProgress");
              $(holder).find(".upload-loader").remove();
              // If upload successful
              if (Math.random() < 0.9) {
                // $(wrapper).append(
                //   '<div class="snackbar show" role="alert"><i class="fa fa-check-circle text-success"></i> Profile image updated successfully</div>'
                // );
                image_status = true;


                // Clear input after upload
                // $(triggerInput).val("");

                setTimeout(() => {
                  $(wrapper).find('[role="alert"]').remove();
                }, 3000);
              } else {
                $(holder).find(".pic").attr("src", currentImg);
                image_status = false;
                $(wrapper).append(
                  '<div class="snackbar show" role="alert"><i class="fa fa-times-circle text-danger"></i> There is an error while uploading! Please try again later.</div>'
                );

                // Clear input after upload
                // $(triggerInput).val("");
                setTimeout(() => {
                  $(wrapper).find('[role="alert"]').remove();
                }, 3000);
              }
            }, 1500);
          };
        } else {
          $(wrapper).append(
            '<div class="alert alert-danger d-inline-block p-2 small" role="alert">Please choose the valid image.</div>'
          );
          setTimeout(() => {
            $(wrapper).find('role="alert"').remove();
          }, 3000);
        }
      });
      $("#constructionForm").on("submit", function (e) {
        e.preventDefault();
        var valid       =   $(this).valid();
        if (valid == true) {
          $("#submitBtn").hide();
          var form = $("#constructionForm");
          var formData = new FormData(form[0]);
          formData.append("action", "update-construction");
          formData.append("construction_ID", construction_ID);
          formData.append("profile_old", $("#profilePic").attr("src"));

          $.ajax({
            type: "POST",
            url: "../controllers/administrator.php",
            dataType: "JSON",
            contentType: false,
            processData: false,
            data: formData,
            success: function (response) {
              if (response["login"] == false) {
                window.location.href = "../index.html";
              }
              if (response["login"] == true) {

                if (response["error"] == true) {
                  alert(response["error_msg"]);

                }
                if (response["error"] == false) {
                  alert("Actualizado Con Ã©xito!");
                  window.location.href = "constructions.html";

                }


              }

            }

          });




        }








      });
      var res = getUser();
      if (res["login"] == false) {
        window.location.href = "../index.html";
      }
      if (res["user"]) {

        $("#user").text(res["user"]["NAME"]);
        $("#user_role").text(res["user"]["DESIGNATION"]);
        $("#userside").text(res["user"]["NAME"]);
        $("#name").val(res["user"]["NAME"]);
        $("#rut").val(res["user"]["RUT"]);


      }

      $('#constructionForm').validate({
        rules:
        {
          construction:
          {
            required: true,

          },
          coordinates:
          {
            required: true,

          },
          address:
          {
            required: true,

          },
          business:
          {
            required: true,

          },
          business_condition:
          {
            required: true,

          },
          amount:
          {
            digits: true,
            required: true,

          },
          start_date:
          {
            required: true,

          },
          end_date:
          {
            required: true,

          },

        },
        messages:
        {
          construction:
          {
            required: "Este Campo Es Obligatorio...",

          },
          coordinates:
          {
            required: "Este Campo Es Obligatorio...",

          },
          address:
          {
            required: "Este Campo Es Obligatorio...",

          },
          business:
          {
            required: "Este Campo Es Obligatorio...",

          },
          business_condition:
          {
            required: "Este Campo Es Obligatorio...",

          },
          amount:
          {
            digits: "Monto Invalido...",
            required: "Este Campo Es Obligatorio...",

          },
          start_date:
          {
            required: "Este Campo Es Obligatorio...",

          },
          end_date:
          {
            required: "Este Campo Es Obligatorio...",

          },

        },
        errorPlacement: function (error, element) {

          $(element).next("small").text($(error).text());
        },
        success: function (element) {
          $(element).next("small").text("");
        },
      });
      var construction_ID = getParameterFromUrl("const_id", window.location.href);
      if (construction_ID == "" ||  construction_ID == null || construction_ID == undefined || construction_ID == 0) 
      {
          window.location.href = "constructions.html";
        
      }
      else
      {
        $.ajax({
          type: "POST",
          data: {"action": "get_construction_by_id", const_ID: construction_ID},
          url: "../controllers/administrator.php",
          dataType: "JSON",
          success: function (response) {
            if (response["login"] == false) {
              window.location.href = "../index.html";
            }
            if (response["login"] == true) {
              if(response["construction"] != "")
              {
                $("#construction").val(response["construction"]["OBRA"]);
                $("#coordinates").val(response["construction"]["CORDINATES"]);
                $("#address").val(response["construction"]["ADRESS"]);
                $("#business").val(response["construction"]["BUS_NAME"]);
                $("#business_condition").val(response["construction"]["BUS_CONDITION"]);
                $("#amount").val(response["construction"]["QTY"]);
                $("#start_date").val(response["construction"]["START_DT"]);
                $("#end_date").val(response["construction"]["END_DATE"]);
                $("#profilePic").attr("src", response["construction"]["IMG_NAME"]);
                $(".uploadProfileInput").val(response["construction"]["IMG_NAME"]);
                $(".uploadProfileInput").trigger("change");





              }


            }

          }

        });
      }

    });
    // $("#construction").select2();











  </script>
</body>

</html>
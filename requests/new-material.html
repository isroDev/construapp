<!DOCTYPE html>
<html lang="en">

<head>
    <meta charset="utf-8">
    <meta name="viewport" content="width=device-width, initial-scale=1">
    <title>Constru App | Agregar Nuevo Material</title>
    <link rel="stylesheet"
        href="https://fonts.googleapis.com/css?family=Source+Sans+Pro:300,400,400i,700&display=fallback">
    <link rel="stylesheet" href="plugins/fontawesome-free/css/all.min.css">
    <link rel="stylesheet" href="plugins/datatables-bs4/css/dataTables.bootstrap4.min.css">
    <link rel="stylesheet" href="plugins/datatables-responsive/css/responsive.bootstrap4.min.css">
    <link rel="stylesheet" href="plugins/datatables-buttons/css/buttons.bootstrap4.min.css">
    <link rel="stylesheet" href="dist/css/adminlte.min.css">
    <link rel="stylesheet" href="../administrator/plugins/select2/css/select2.min.css">

    <style>
        #example1 th {
            font-weight: 500;
        }

        .det_btn {
            color: #333;
            font-size: 20px;
        }

        .select2-selection__rendered {
            line-height: 31px !important;
            border-color: #ccc;
        }

        .select2-container .select2-selection--single {
            height: 38px !important;
            border: 1px solid #ccc;
        }

        .select2-selection__arrow {
            height: 38px !important;
        }

        small {
            color: red;
        }
    </style>
</head>

<body class="hold-transition sidebar-mini layout-fixed">
    <div class="wrapper">


        <div class="preloader flex-column justify-content-center align-items-center">
            <img class="animation__shake" src="../img/AdminLTELogo.png" alt="AdminLTELogo" height="60" width="60">
        </div>
        <nav class="main-header navbar navbar-expand navbar-white navbar-light">

            <ul class="navbar-nav">
                <li class="nav-item">
                    <a class="nav-link" data-widget="pushmenu" href="#" role="button"><i class="fas fa-bars"></i></a>
                </li>
                <li class="nav-item d-none d-sm-inline-block">
                    <a href="#" class="nav-link">SOLICITUDES</a>
                </li>

            </ul>
            <ul class="navbar-nav ml-auto">


                <li class="nav-item dropdown">
                    <a class="nav-link" id="user" data-toggle="dropdown" href="#"></a>
                    <div class="dropdown-menu dropdown-menu-lg dropdown-menu-right">
                        <a href="../controllers/logout.php" class="dropdown-item">Logout</a>


                    </div>
                </li>

            </ul>
        </nav>

        <aside class="main-sidebar sidebar-dark-primary elevation-4">

            <a href="#" class="brand-link">
                <p class="brand-text font-weight-light"
                    style="text-align: center; font-size: 30px; letter-spacing: 1px">CONSTRU
                    <strong>APP</strong>
                </p>
            </a>


            <div class="sidebar">

                <div class="user-panel mt-3 pb-3 mb-3 d-flex">
                    <div class="image">

                        <i class="fas fa-search fa-user" style="font-size: 24px; color: #fff; margin-top: 12px"></i>
                    </div>
                    <div class="info">
                        <a href="#" class="d-block" id="sidebar_username"></a>
                        <a class="d-block" id="sidebar_user_role"
                            style="font-size: 14px; color: #fff; font-weight: 500; letter-spacing: 1px;"></a>
                    </div>
                </div>



                <nav class="mt-2">
                    <ul class="nav nav-pills nav-sidebar flex-column" data-widget="treeview" role="menu"
                        data-accordion="false">

                        <li class="nav-header">BODEGUERO</li>
                        <li class="nav-item">
                            <a href="#" class="nav-link">
                                <i class="nav-icon fas fa-shopping-cart"></i>
                                <p>
                                    Entregas
                                    <i class="right fas fa-angle-left"></i>
                                </p>
                            </a>
                            <ul class="nav nav-treeview">
                                <li class="nav-item">
                                    <a href="material-delivery.html" class="nav-link">
                                        <i class="fas fa-circle nav-icon"></i>
                                        <p>Nueva Entrega</p>
                                    </a>
                                </li>
                                <li class="nav-item">
                                    <a href="material-deliveries.html" class="nav-link">
                                        <i class="fas fa-circle nav-icon"></i>
                                        <p>Ver Entregas</p>
                                    </a>
                                </li>

                            </ul>
                        </li>
                        <li class="nav-item">
                            <a href="#" class="nav-link">
                                <i class="nav-icon fas fa-window-restore"></i>
                                <p>
                                    Recepciones
                                    <i class="right fas fa-angle-left"></i>
                                </p>
                            </a>
                            <ul class="nav nav-treeview">
                                <li class="nav-item">
                                    <a href="material-return.html" class="nav-link">
                                        <i class="fas fa-circle nav-icon"></i>
                                        <p>Nuevo Recibo</p>
                                    </a>
                                </li>
                                <!-- <li class="nav-item">
                        <a href="#" class="nav-link">
                          <i class="fas fa-circle nav-icon"></i>
                          <p>Ver Recibos</p>
                        </a>
                    </li> -->

                            </ul>
                        </li>
                        <li class="nav-item">
                            <a href="#" class="nav-link">
                                <i class="nav-icon fas fa-truck"></i>
                                <p>
                                    Proveedor
                                    <i class="right fas fa-angle-left"></i>
                                </p>
                            </a>
                            <ul class="nav nav-treeview">
                                <li class="nav-item">
                                    <a href="materials-receive-supplier.html" class="nav-link">
                                        <i class="fas fa-circle nav-icon"></i>
                                        <p>Recepción De material</p>
                                    </a>
                                </li>

                                <li class="nav-item">
                                    <a href="supplier-refund.html" class="nav-link">
                                        <i class="fas fa-circle nav-icon"></i>
                                        <p>Devolución Material</p>
                                    </a>
                                </li>

                            </ul>
                        </li>


                        <li class="nav-item">
                            <a href="warehouse-supply.html" class="nav-link">
                                <i class="fas fa-house-user nav-icon"></i>
                                <p>Abastecimiento Bodega
                                </p>
                            </a>
                        </li>
                        <li class="nav-item">
                            <a href="#" class="nav-link">
                                <i class="nav-icon fas fa-chalkboard-teacher"></i>
                                <p>
                                    Solicitudes
                                    <i class="right fas fa-angle-left"></i>
                                </p>
                            </a>
                            <ul class="nav nav-treeview">
                                <li class="nav-item">
                                    <a href="new-request.html" class="nav-link">
                                        <i class="fas fa-circle nav-icon"></i>
                                        <p>Nueva Solicitud</p>
                                    </a>
                                </li>


                                <li class="nav-item">
                                    <a href="requests.html" class="nav-link">
                                        <i class="fas fa-circle nav-icon"></i>
                                        <p>Ver Solicitudes</p>
                                    </a>
                                </li>


                            </ul>
                        </li>
                        <li class="nav-item">
                            <a href="#" class="nav-link">
                                <i class="nav-icon fas fa-store-alt"></i>
                                <p>
                                    Inventario
                                    <i class="right fas fa-angle-left"></i>
                                </p>
                            </a>
                            <ul class="nav nav-treeview">
                                <li class="nav-item">
                                    <a href="inventory-stock.html" class="nav-link">
                                        <i class="fas fa-circle nav-icon"></i>
                                        <p>
                                            Materiales De Inventario</p>
                                    </a>
                                </li>


                                <li class="nav-item">
                                    <a href="materials-inventory.html" class="nav-link">
                                        <i class="fas fa-circle nav-icon"></i>
                                        <p>Ver Registros</p>
                                    </a>
                                </li>
                                <li class="nav-item">
                                    <a href="material_receipt.html" class="nav-link">
                                        <i class="fas fa-circle nav-icon"></i>
                                        <p>Nuevo Registro</p>
                                    </a>
                                </li>



                            </ul>
                        </li>



                        <li class="nav-item" id="nav-material" style="display: none;">
                            <a href="new-material.html" class="nav-link">
                                <i class="nav-icon fas fa-briefcase-medical"></i>
                                <p>Agregar Nuevo Material</p>
                            </a>
                        </li>
                        <li class="nav-item">
                            <a href="../controllers/logout.php" class="nav-link">
                                <i class="nav-icon far fa-circle text-warning"></i>
                                <p>Logout</p>
                            </a>
                        </li>

                    </ul>
                </nav>

            </div>

        </aside>


        <div class="content-wrapper" style="overflow: hidden">
            <section class="content-header">
                <div class="container-fluid">
                    <div class="row mb-2">
                        <div class="col-sm-6">
                            <h1>Agregar Nuevo Material</h1>
                        </div>
                        <div class="col-sm-6">
                            <ol class="breadcrumb float-sm-right">
                                <li class="breadcrumb-item"><a href="#">Home</a></li>
                                <li class="breadcrumb-item active">Agregar Nuevo Material</li>
                            </ol>
                        </div>
                    </div>
                </div>
            </section>
            <section class="content">
                <div class="container-fluid">
                    <div class="row">
                        <div class="col-12">


                            <div class="card">
                                <div class="card-header">
                                    <form id="materialForm" href="#" method="POST">
                                        <div class="row">
                                            <div class="col-md-3">
                                                <label
                                                    style="font-weight: 500; font-size: 16px; width: 100%;">Código
                                                    Material Tienda</label>
                                                <input readonly
                                                    style="font-size: 30px; text-align: center; letter-spacing: 5px; font-weight: 500; background-color: #fff;"
                                                    class="form-control mb-2 mr-sm-2 form-control-sm" id="material_code"
                                                    name="material_code" />
                                                <small id="material_error"></small>

                                            </div>
                                            <div class="col-md-2">
                                                <button class="btn btn-sm btn-primary" id="barcodeBtn"
                                                    style="width: 100%; margin-top: 32px;">Generar</button>

                                            </div>
                                            <div class="col-md-2">
                                                <button class="btn btn-sm btn-outline-success" id="printBtn"
                                                    style="width: 100%; margin-top: 32px;">Impresión</button>

                                            </div>
                                            
                                            <!-- <div class="col-md-4">
                                                <label
                                                    style="font-weight: 500; font-size: 16px;width: 100%; text-align: center;">Código
                                                    De Barras De Material</label>
                                                <input style="text-align: center; font-size: 24px; letter-spacing: 5px;"
                                                    class="form-control mb-2 mr-sm-2 form-control-sm" id="barcode"
                                                    name="barcode" />
                                                <small></small>

                                            </div> -->


                                        </div>
                                        <div class="row" style="display: none; margin: 10px 0px" id="barcodeDiv">
                                            <div class="col-md-3">
                                                <div>
                                                    <img id="barcode_img" style="height: 9vh;max-width: 100%;"/>
                                                    <div id="itmcode" style="font-weight: 700; font-size: 17px;text-align: justify; text-align-last: justify;"></div>

                                                </div>
                                                
                                                

                                            </div>

                                        </div>
                                        <div class="row">
                                            <div class="col-md-3">
                                                <label style="font-weight: 500; font-size: 16px;">Categoria
                                                    Principal</label>
                                                <select class="form-control mb-2 mr-sm-2 form-control-sm"
                                                    id="main_category" name="main_category">
                                                    <option value="">Elegir La Categoría</option>

                                                </select>
                                                <small id="main_error"></small>

                                            </div>
                                            <div class="col-md-4">
                                                <label style="font-weight: 500; font-size: 16px;">Nombre Del
                                                    Material</label>
                                                <input class="form-control mb-2 mr-sm-2" id="material_name"
                                                    name="material_name"  placeholder="Ingrese el nombre del material"/>
                                                <small></small>

                                            </div>
                                            <div class="col-md-3">
                                                <label style="font-weight: 500; font-size: 16px;">Unidad</label>
                                                <select class="form-control form-control-sm mb-2 mr-sm-2" id="unit"
                                                    name="unit">
                                                    <option value="">Elija Unidad</option>

                                                </select>
                                                <small id="unit_error"></small>


                                            </div>
                                            <div class="col-md-2">
                                                <label style="font-weight: 500; font-size: 16px;">Stock De
                                                    Apertura</label>
                                                <input type="number" class="form-control mb-2 mr-sm-2"
                                                    id="opening_stock" name="opening_stock" style="text-align: right;"
                                                    value="0" min="0" />
                                                <small></small>

                                            </div>

                                        </div>

                                        <div class="row">

                                            <div class="col-md-12">
                                                <button type="submit" style="float: right; margin-top: 10px;"
                                                    class="btn btn-success mb-2 btn-sm">AGREGAR</button>
                                            </div>

                                        </div>







                                    </form>




                                </div>

                                <div class="card-body">
                                    <table id="example1" class="table table-bordered table-striped">
                                        <thead style="background-color: #343a40; color: #fff;">
                                            <tr>
                                                <th>ID De Material</th>
                                                <th>Categoría</th>
                                                <th>Nombre</th>
                                                <th>Unidad</th>
                                                <th style="text-align: center;">Stock De Apertura</th>

                                            </tr>
                                        </thead>
                                        <tbody id="table">

                                        </tbody>


                                    </table>
                                </div>

                            </div>

                        </div>

                    </div>

                </div>

            </section>

        </div>

        <footer class="main-footer">
            <p style="text-align: center">Copyright &copy; 2021 <a href="#">ConstruApp</a>. All rights reserved.</p>


        </footer>
        <aside class="control-sidebar control-sidebar-dark">
        </aside>
    </div>

    <script src="plugins/jquery/jquery.min.js"></script>
    <script src="plugins/bootstrap/js/bootstrap.bundle.min.js"></script>
    <script src="plugins/datatables/jquery.dataTables.min.js"></script>
    <script src="plugins/datatables-bs4/js/dataTables.bootstrap4.min.js"></script>
    <script src="plugins/datatables-responsive/js/dataTables.responsive.min.js"></script>
    <script src="plugins/datatables-responsive/js/responsive.bootstrap4.min.js"></script>
    <script src="plugins/datatables-buttons/js/dataTables.buttons.min.js"></script>
    <script src="plugins/datatables-buttons/js/buttons.bootstrap4.min.js"></script>
    <script src="plugins/jszip/jszip.min.js"></script>
    <script src="plugins/pdfmake/pdfmake.min.js"></script>
    <script src="plugins/pdfmake/vfs_fonts.js"></script>
    <script src="plugins/datatables-buttons/js/buttons.html5.min.js"></script>
    <script src="plugins/datatables-buttons/js/buttons.print.min.js"></script>
    <script src="plugins/datatables-buttons/js/buttons.colVis.min.js"></script>
    <script src="dist/js/adminlte.min.js"></script>
    <script src="dist/js/demo.js"></script>
    <script src="dist/js/functions.js"></script>
    <script src="../administrator/plugins/select2/js/select2.min.js"></script>
    <script src="./dist/js/jquery.validate.min.js"></script>
    <script src="./dist/js/additional-methods.min.js"></script>
    <script src="https://cdnjs.cloudflare.com/ajax/libs/jQuery.print/1.3.3/jQuery.print.min.js"></script>



    <script>
        $(document).ready(function () {

            var material_ID;
            $("#main_category").select2();
            $("#unit").select2();
            $.ajax({
                type: "POST",
                url: "../controllers/bodegaController.php",
                dataType: "JSON",
                data: { action: "get_materials" },
                success: function (response) {
                    if (response["materials_list"]) {

                        $.each(response["materials_list"], function (index, element) {
                            row = "<tr><td>" + element["ITMCODE"] + "</td><td>" + element["CATEGORY"] + "</td><td>" + element["MATERIAL_NAME"] + "</td><td>" + element["UNIT"] + "</td><td style='text-align: center'>" + element["OPN_STK"] + "</td></tr>";
                            $("#table").append(row);

                        });
                        $("#example1").DataTable
                            ({
                                "responsive": true,
                                "lengthChange": false,
                                "autoWidth": false,
                                "pageLength": 20,
                                "buttons": ["copy", "csv", "excel", "pdf", "print"]
                            }).buttons().container().appendTo('#example1_wrapper .col-md-6:eq(0)');
                    }

                },

            });
            $.ajax({
                type: "POST",
                url: "../controllers/bodegaController.php",
                dataType: "JSON",
                data: { action: "get_units" },
                success: function (response) {
                    if (response != "") {
                        material_ID = response["MATERIAL_ID"];
                        var units = response["units_list"];
                        $.each(units, function (index, element) {
                            $("#unit").append("<option value='" + element["UNIT_ID"] + "'>" + element["DESCRIPTION"] + "</option");

                        });
                    }

                },

            });
            $.ajax({
                type: "POST",
                url: "../controllers/bodegaController.php",
                dataType: "JSON",
                data: { action: "get_main" },
                success: function (response) {
                    if (response != "") {
                        var categories = response["list"];
                        $.each(categories, function (index, element) {
                            $("#main_category").append("<option value='" + element["MAIN_ID"] + "'>" + element["DESCRIP"] + "</option");

                        });
                    }

                },

            });
            $('#materialForm').validate({
                rules:
                {
                    material_name: {
                        required: true,


                    },
                    opening_stock: {
                        required: true,

                    },
                    barcode:
                    {
                        required: true,
                        digits: true,
                        // minlength: 6,
                        // maxlength: 8
                    }

                },
                messages: {

                    material_name: {
                        required: "Este Campo Es Obligatorio",

                    },
                    opening_stock: {
                        required: "Este Campo Es Obligatorio",

                    },
                    barcode: {
                        required: "Este Campo Es Obligatorio",
                        digits: "Solo se permiten dígitos",
                        // minlength: "La longitud mínima es de seis dígitos",
                        // maxlength: ""
                    }
                },
                errorPlacement: function (error, element) {

                    $(element).next("small").text($(error).text());
                },
                success: function (element) {
                    $(element).next("small").text("");
                },

            });

            $("#main_category").on("change", function () {
                if ($(this).val() == "") {
                    $("#main_error").text("Este Campo Es Obligatorio");

                }
                else {
                    $("#main_error").text("");
                    $("#material_code").val("");
                    $("#material_code").val($(this).val() + material_ID);

                }

            });
            $("#unit").on("change", function () {
                if ($(this).val() == "") {
                    $("#unit_error").text("Este Campo Es Obligatorio");

                }
                else {
                    var main_ID = $("#main_category").val();
                    $("#material_code").val(main_ID + material_ID + $(this).val());

                }

            });

            $('#materialForm').on("submit", function (event) {
                event.preventDefault();
                if ($(this).valid() == true) {
                    $("#material_code").val("");
                    var main_ID = $("#main_category").val();
                    var unit_ID = $("#unit").val();
                    var material_name = $("#material_name").val();
                    var itmcode = main_ID + material_ID + unit_ID;
                    $("#material_code").val(itmcode);
                    if (itmcode != "") {

                        $.ajax({
                            type: "POST",
                            url: "../controllers/bodegaController.php",
                            dataType: "JSON",
                            data: { action: "register-material", itmcode: itmcode, material_name: material_name, main_ID: main_ID, unit_ID: unit_ID, material_ID: material_ID, opn_stk: $("#opening_stock").val()},
                            success: function (response) {
                                if (response["status"] == true) {
                                    alert("Material Registrado Con éxito");
                                    window.location.reload();

                                }
                                if (response["status"] == false) {
                                    alert("No se pudo agregar el material. Vuelve a intentarlo.");

                                }

                            },

                        });

                    }

                }


            });
            $("#barcodeBtn").on("click", function (e) {
                e.preventDefault();
                var itmcode = $("#material_code").val();
                if (itmcode == "") {
                    $("#material_error").text("Código De Material Mo Válido");

                }
                if (itmcode.length  != 8) {
                    $("#material_error").text("Código De Material Puede Tener Solo 8 Dígitos");

                }
                if(itmcode.length == 8 && itmcode != "") 
                {
                    $("#material_error").text("");

                    $.ajax({
                        type: "POST",
                        url: "../controllers/bodegaController.php",
                        data: { action: "generate_barcode", itmcode: itmcode},
                        success: function (response) {
                            if (response) {
                                var barcode = JSON.parse(response);
                                if(barcode != "")
                                {
                                    $("#barcode_img").attr("src", barcode["barcode"]);
                                    $("#itmcode").text(barcode["code"]);
                                    $("#barcodeDiv").show();
                                }
                                
                                console.log(barcode);

                            }
                           
                        },

                    });

                }


            });
            $('#printBtn').on('click', function(e) {
                e.preventDefault();
                $.print("#barcode_img"); 
            });

        });










    </script>
</body>

</html>